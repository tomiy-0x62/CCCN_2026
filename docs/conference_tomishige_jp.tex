\documentclass[twocolumn,a4paper]{ltjsreport}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{textcomp}
\usepackage{latexsym}
\usepackage[fleqn]{amsmath}
%\usepackage{amssymb}
\usepackage{float}
\usepackage{graphicx}

\usepackage[subrefformat=parens]{subcaption}
\usepackage{url}

\title{\textbf{ Performance Analysis of a Node and Module Discovery Protocol in Data Distribution Service } }
  \author{
    Ryosuke  Tomishige\thanks{Okayama University} \and
    Yuya Tarutani\thanks{The University of Osaka} \and
    Tokumi Yokohira\thanks{Okayama University} \and
    Yuki Takano\thanks{TIER IV, Inc.} \and
    Koichi Imai\thanks{TIER IV, Inc.}
  }

\begin{document}
\maketitle
\section{イントロ}
自動運転システムで採用されているROS 2はData Distribution Service (DDS)と呼ばれる
Pub/Sub 通信のミドルウェアを用いる。
DDSネットワークに参加するプロセスをノードと呼び、各ノードはトピックを出版/購読するためのモジュールを持つ。
各モジュールは他のモジュールをDiscovery Protocol (発見プロトコル)と呼ばれる仕組みを使用して自動的に発見し、通信を行なう。
標準の発見プロトコルとして規定されているSimple Discovery Protocol (SDP)はノード発見とモジュール発見の2つの段階で構成される。
しかし、SDPは小規模から中規模のネットワークを対象としており、大規模なネットワークで使用されることが想定されていない。

ROS2でサポートされているDDS実装のうち、eProsima’s Fast DDS、Eclipse Cyclone DDSの２つについて性能を確認する。


\section{Simpel Discovery Protocol}
% \begin{figure}[ht]
      % \centering
      % \includegraphics[keepaspectratio, scale=0.4]{images/SDP.drawio.png}
  % \caption{SDPのシーケンスの概略}
  % \label{fig:sdp_seq}
% \end{figure}
SDPのシーケンスの概略を図\ref{fig:sdp_seq}に示す。
各ノードは自身の情報を含むSPDPメッセージを定期的に
送信し、ネットワーク上の他のノードに自身の存在を知らせる。
SPDPメッセージを受信したノードは
自身のモジュール情報を含むSEDPメッセージを
送信する。

DDSのメッセージにはシーケンス番号が振られており、
SEDPでは信頼性確保のために、定期的に送信済みSEDPメッセージのシーケンス番号の一覧をHBメッセージで送信し、それを受信したノードは肯定確認応答または再送要求をACKNACKメッセージで送信ノードに伝える。
このとき、未知のノードからのSPDP以外のメッセージは図\ref{fig:sdp_seq}の二本目の矢印のように無視される。
両ノードがお互いを発見した後にSEDPメッセージを受信することで他のノードが持つモジュールを発見する。


\section{性能解析のための評価実験}
すべてのノードが他ノードのもつ全モジュールの情報を受信するまでにかかる時間をDiscovery Timeと定義する。
SDPのスケーラビリティを検証するために、
車載ネットワークを模した多数のノードが存在するネットワークで
ノードを同時に立ち上げたときの、Discovery Timeを計測する。
2台のホストを用意し、同一のトピックの出版/購読モジュールをそれぞれ1つ持つノードをFast DDS, Cyclone DDSで実装し、
各ホストで102ずつ立ち上げ実験を行なった。

\begin{figure}[t]
  \begin{tabular}{cc}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      \includegraphics[keepaspectratio, scale=0.16]{images/graph_fast_1.png}
      \subcaption{Fast DDS}
      \label{fig:ex_fast_1}
    \end{minipage}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      \includegraphics[keepaspectratio, scale=0.16]{images/graph_cyclone_1.png}
      \subcaption{Cyclone DDS}
      \label{fig:ex_cyclone_1}
    \end{minipage} &
  \end{tabular} \\
  \caption{Discovery Time}
  \label{fig:ex_fast}
\end{figure}

実験結果を図\ref{fig:ex_fast}に示す。
Fast DDSは45s、Cyclone DDSは22sだった。
Cycloneにはグラフに垂直なラインが見られるが、Fastには垂直なラインがみられない。

この差の原因として、UDPソケットの受信バッファーが原因として考えられるため、各実装のソケット受信バッファーを変更して実験した。

\begin{figure}[t]
  \begin{tabular}{cc}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      \includegraphics[keepaspectratio, scale=0.16]{images/graph_fast_2.png}
      \subcaption{Fast DDS 1MiB}
      \label{fig:ex_fast_2}
    \end{minipage}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      \includegraphics[keepaspectratio, scale=0.16]{images/graph_fast_3.png}
      \subcaption{Fast DDS 10MiB}
      \label{fig:ex_fast_3}
    \end{minipage} &
  \end{tabular} \\
  \begin{tabular}{cc}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      \includegraphics[keepaspectratio, scale=0.16]{images/graph_cyclone_2.png}
      \subcaption{Cyclone DDS 1MiB}
      \label{fig:ex_cyclone_2}
    \end{minipage}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      \includegraphics[keepaspectratio, scale=0.16]{images/graph_cyclone_3.png}
      \subcaption{Cyclone DDS 10MiB}
      \label{fig:ex_cyclone_3}
    \end{minipage} &
  \end{tabular} \\
  \caption{Discovery Time}
  \label{fig:ex_fast}
\end{figure}


\begin{table}
  \centering\small
  \caption{Discovery Time}
  \label{tab:disc_time}
  \smallskip
  \begin{tabular}{|l|r|r|} \hline
    Impl & recv buf size (MiB) & Discovery Time (s) \\ \hline
    Fast & 1 & 36 \\ \hline
    Fast & 10 & 36 \\ \hline
    Cyclone & 1 & 21 \\ \hline
    Cyclone & 10 & 22 \\ \hline
  \end{tabular}
\end{table}
どちらの実装でも1MiB, 10MiBで変化無し。
Cycloneはデフォルトが1MiBなので明示的に指定しても変化無し。
Fastはデフォルトではカーネルのデフォルト値を使用し、実験環境では256KiB。1MiBに変更すると改善するがそれでもCycloneに比べて遅い。

1. なぜFastはCycloneと比較してソケットバッファのサイズが同じでもDiscoveryが遅いのか？

あるノードに対して時間あたりに送信されるメッセージ数
\begin{figure}[t]
  \begin{tabular}{cc}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      \includegraphics[keepaspectratio, scale=0.1]{images/fast_receive_per_node.png}
        \subcaption{Fast DDS}
      \label{fig:fast_send_msg}
    \end{minipage}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      \includegraphics[keepaspectratio, scale=0.1]{images/cyclone_receive_per_node.png}
      \subcaption{Cyclone DDS}
      \label{fig:cyclone_send_msg}
    \end{minipage} &
  \end{tabular}
  \caption{send message}
  \label{fig:ex_fast}
\end{figure}

\begin{figure}[t]
  \begin{tabular}{cc}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      \includegraphics[keepaspectratio, scale=0.16]{images/graph_fast_uni_drop_1.png}
      \subcaption{Fast DDS Uni}
      \label{fig:ex_fast_2}
    \end{minipage}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      \includegraphics[keepaspectratio, scale=0.16]{images/graph_fast_mul_drop_1.png}
      \subcaption{Fast DDS Multi}
      \label{fig:ex_fast_3}
    \end{minipage} &
  \end{tabular} \\
  \begin{tabular}{cc}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      \includegraphics[keepaspectratio, scale=0.16]{images/graph_cyclone_mul_drop_1.png}
      \subcaption{Cyclone DDS Uni}
      \label{fig:ex_cyclone_2}
    \end{minipage}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      \includegraphics[keepaspectratio, scale=0.16]{images/graph_cyclone_mul_drop_1.png}
      \subcaption{Cyclone DDS Multi}
      \label{fig:ex_cyclone_3}
    \end{minipage} &
  \end{tabular} \\
  \caption{Discovery Time}
  \label{fig:ex_fast}
\end{figure}

シンプルにFast DDSのメッセージ処理速度が遅い可能性が高い
Fast DDSは意図的に5msのレイテンシを入れてるが、それよりも遥かに実測レイテンシが大きい。
TODO: CPU負荷の観点からチェック

Fast DDS: 100ms〜200ms

HB Multicast 1.873854

ACKNACK 1.906739

DATA(w) 2.124689

Cyclone DDS: ほぼ0

HB Multicast 0.002968

ACKNACK 0.003874

DATA(w) 0.004259

疑問2. CycloneとFastのdiscoveryの進み方の差はどのような実装、パラメータの差によるものなのか？

メッセージの送信周期や送信方法、送信タイミングなどの差はあるが、影響はほとんど無さそう。
すべてFast DDSのメッセージ処理速度で説明できる。
Cyclone DDS: DATA(w)のunicast, multicastの割合が1:1
Fast DDS: DATA(w)のunicast, multicastの割合が1:0

Fastでノード数を半分にするとどうなるのか？
12s程度でdiscovery完了するようになる。
グラフに垂直なラインがみられるようになった。

\begin{figure}[ht]
  \centering
  \includegraphics[keepaspectratio, scale=0.4]{images/graph_fast_4.png}
  \caption{Fast DDS half node}
  \label{fig:fast_half}
\end{figure}

% \section{まとめ}
% 実験により、合計204ノード、408モジュールで構成されるDDSネットワークにおいてモジュール発見段階で多数のパケットドロップが発生し、
% 全モジュールの発見に約50秒かかることが確認できた。
% また、モジュール発見の段階が問題の原因であることをメッセージ複雑度の計算によっても確認できた。


\end{document}
