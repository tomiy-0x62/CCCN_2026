\documentclass[twocolumn,a4paper]{ltjsreport}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{textcomp}
\usepackage{latexsym}
\usepackage[fleqn]{amsmath}
%\usepackage{amssymb}
\usepackage{float}
\usepackage{graphicx}

\usepackage[subrefformat=parens]{subcaption}
\usepackage{url}

\title{\textbf{ Performance Analysis of a Node and Module Discovery Protocol in Data Distribution Service } }
  \author{
    Ryosuke  Tomishige\thanks{Okayama University} \and
    Yuya Tarutani\thanks{The University of Osaka} \and
    Tokumi Yokohira\thanks{Okayama University} \and
    Yuki Takano\thanks{TIER IV, Inc.} \and
    Koichi Imai\thanks{TIER IV, Inc.}
  }

\begin{document}
\maketitle
\section{イントロ}
自動運転システムで採用されているROS 2はData Distribution Service (DDS)と呼ばれる
Pub/Sub 通信のミドルウェアを用いる。
DDSネットワークに参加するプロセスをノードと呼び、各ノードはトピックを出版/購読するためのモジュールを持つ。
各モジュールは他のモジュールをDiscovery Protocol (発見プロトコル)と呼ばれる仕組みを使用して自動的に発見し、通信を行なう。
標準の発見プロトコルとして規定されているSimple Discovery Protocol (SDP)はノード発見とモジュール発見の2つの段階で構成される。
しかし、SDPは小規模から中規模のネットワークを対象としており、大規模なネットワークで使用されることが想定されていない。

ROS2でサポートされているDDS実装のうち、eProsima’s Fast DDS、Eclipse Cyclone DDSの２つについて性能を確認する。


\section{Simpel Discovery Protocol}
% \begin{figure}[ht]
      % \centering
      % \includegraphics[keepaspectratio, scale=0.4]{images/SDP.drawio.png}
  % \caption{SDPのシーケンスの概略}
  % \label{fig:sdp_seq}
% \end{figure}
SDPのシーケンスの概略を図\ref{fig:sdp_seq}に示す。
各ノードは自身の情報を含むSPDPメッセージを定期的に
送信し、ネットワーク上の他のノードに自身の存在を知らせる。
SPDPメッセージを受信したノードは
自身のモジュール情報を含むSEDPメッセージを
送信する。

DDSのメッセージにはシーケンス番号が振られており、
SEDPでは信頼性確保のために、定期的に送信済みSEDPメッセージのシーケンス番号の一覧をHBメッセージで送信し、それを受信したノードは肯定確認応答または再送要求をACKNACKメッセージで送信ノードに伝える。
このとき、未知のノードからのSPDP以外のメッセージは図\ref{fig:sdp_seq}の二本目の矢印のように無視される。
両ノードがお互いを発見した後にSEDPメッセージを受信することで他のノードが持つモジュールを発見する。


\section{性能解析のための評価実験}
すべてのノードが他ノードのもつ全モジュールの情報を受信するまでにかかる時間をDiscovery Timeと定義する。
SDPのスケーラビリティを検証するために、
車載ネットワークを模した多数のノードが存在するネットワークで
ノードを同時に立ち上げたときの、Discovery Timeを計測する。
2台のホストを用意し、同一のトピックの出版/購読モジュールをそれぞれ1つ持つノードをFast DDS, Cyclone DDSで実装し、
各ホストで102ずつ立ち上げ実験を行なった。

\begin{figure}[t]
  \begin{tabular}{cc}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      % \includegraphics[keepaspectratio, scale=0.16]{images/graph_dds_pub_ori.png}
      \subcaption{Discovered pub modules}
      \label{fig:ex_fast_dds_pub}
    \end{minipage}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      % \includegraphics[keepaspectratio, scale=0.16]{images/graph_all_ori.png}
      \subcaption{unicast packet drop} % unicast drop
      \label{fig:ex_fast_uni}
    \end{minipage} &
  \end{tabular} \\
  \caption{Discovery Time}
  \label{fig:ex_fast}
\end{figure}

実験結果を図\ref{fig:ex_fast}に示す。
Fast DDSは50s程度、Cyclone DDSは23秒程度だった。

この差の原因として、UDPソケットの受信バッファーが原因として考えられるため、各実装のソケット受信バッファーを変更して実験した。

\begin{figure}[t]
  \begin{tabular}{cc}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      % \includegraphics[keepaspectratio, scale=0.16]{images/graph_dds_pub_ori.png}
      \subcaption{Fast DDS 1MiB}
      \label{fig:ex_fast_dds_pub}
    \end{minipage}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      % \includegraphics[keepaspectratio, scale=0.16]{images/graph_all_ori.png}
      \subcaption{Fast DDS 10MiB} % unicast drop
      \label{fig:ex_fast_uni}
    \end{minipage} &
  \end{tabular} \\
  \begin{tabular}{cc}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      % \includegraphics[keepaspectratio, scale=0.16]{images/graph_dds_pub_ori.png}
      \subcaption{Cyclone DDS 1MiB}
      \label{fig:ex_fast_dds_pub}
    \end{minipage}
    \begin{minipage}[t]{0.5\hsize}
      \centering
      % \includegraphics[keepaspectratio, scale=0.16]{images/graph_all_ori.png}
      \subcaption{Cyclone DDS 10MiB} % unicast drop
      \label{fig:ex_fast_uni}
    \end{minipage} &
  \end{tabular} \\
  \caption{Discovery Time}
  \label{fig:ex_fast}
\end{figure}

Cyclone 1MBでも十分早い。
Fast 10MBにすると改善するがそれでもCycloneに比べて遅い。

疑問1. なぜFastはCycloneと比較して必要なソケットバッファが多いのか？

シンプルにFast DDSのメッセージ処理速度が遅い可能性が極めて高い

疑問2. CycloneとFastのdiscoveryの進み方の差はどのような実装、パラメータの差によるものなのか？

各ノードの起動開始時刻を$t = 0$とし、
図\ref{fig:ex_fast_dds_pub}は各ノードにおける発見済み出版モジュール数、
図\ref{fig:ex_fast_uni}は各UDPソケットにおける累積パケットドロップ数である。
図\ref{fig:ex_fast_dds_pub}からモジュール発見の完了まで50秒程度かかっていることが観測された。
図\ref{fig:ex_fast_uni}から出版モジュール発見が完了するまでの間、多数のパケットがドロップしており、
図\ref{fig:ex_fast_dds_pub}でモジュールを新規に発見が発生してい時間と図\ref{fig:ex_fast_uni}でパケットドロップが多発している時間が一致しているため、
モジュール発見段階でパケットドロップが発生しているといえる。

パケットドロップが多発する原因としてモジュール発見のメッセージ数が大きいことが考えられる。
総ノード数を$P$, 各ノードの平均モジュール数を$E$、各ノードでの平均ドロップ率を$D$とすると、
モジュール発見のメッセージ複雑度は$O\left(P^{2}ED^{2}\right)$
と表せる。このため、ノード数が多くなるとメッセージ数が非常に多くなる。

% \section{まとめ}
% 実験により、合計204ノード、408モジュールで構成されるDDSネットワークにおいてモジュール発見段階で多数のパケットドロップが発生し、
% 全モジュールの発見に約50秒かかることが確認できた。
% また、モジュール発見の段階が問題の原因であることをメッセージ複雑度の計算によっても確認できた。


\end{document}
